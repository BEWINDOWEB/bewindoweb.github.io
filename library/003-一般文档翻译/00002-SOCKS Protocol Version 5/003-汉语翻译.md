# SOCKS协议第5版

## 本文档的相关信息

本文档指定了互联网社区的互联网标准追踪协议，并且需要大家的讨论和建议来对其进行优化。请参看当前版本的“互联网官方协议标准”（STD 1）以了解该协议的标准化情况和状态。对本文档的分享转发是不限制的。

## 致谢

本文档描述了由第4版[1]改进而来的新协议。这份协议的产生离不开积极的讨论和原型的实现，核心贡献者有： Marcus Leech: Bell-Northern Research, David Koblas: Independent Consultant, Ying-Da Lee: NEC Systems Laboratory, LaMont Jones: Hewlett-Packard Company, Ron Kuris: Unify Corporation, Matt Ganis: International Business Machines.

## 1. 简介

利用网络防火墙，系统可以有效地隔离内部组织网络结构和外部网络，例如越来越受欢迎的因特网。这些防火墙系统总是充当网络之间的应用层网关，通常可以提供受控的Telnet、FTP和SMTP访问。随着为促进全局信息发现而设计的更加复杂的应用层协议的出现，有必要为这些协议提供一个透明且安全的穿透防火墙的通用框架。

此外，还有对这种穿透过程进行兼顾细粒度和实用性的强认证的需求。这种要求来源于各组织的网络之间的客户端-服务器关系的实现，并且这种关系需要被控制和多次地强认证。

这里描述的协议旨在为基于TCP和UDP的客户端-服务器应用提供一个安全便捷地使用网络防火墙服务的框架。该协议在概念上是介于应用层和传输层之间的“薄片层”，因此并不提供网络层的网关服务，如转发ICMP消息。

## 2. 已有的实践

目前存在的SOCKS4协议提供了基于TCP的客户端-服务器应用的不安全的防火墙穿透，包括Telnet、FTP和流行的信息发现协议比如HTTP、WAIS和GOPHER。

该新协议扩展了SOCKS4的模型以引入UDP，还扩展了框架以引入广义强认证方案的规定，并且扩展了寻址方案以引入域名和IPv6地址。

SOCKS协议的实现通常涉及基于TCP的客户端应用程序的重新编译或者重新链接以便使用SOCKS库中合适的封装程序。

### 注:

除非有其他说明，包格式图解中出现的十进制数字代表把八字节的相关字段的长度。一个给定的八字节必须有一个指定的值，格式x“hh”被用于表示那个昱中的单八字节的值。如果使用的是单词“Variable”，则表示相关的字段有一个可变长度，这个长度由结合一个或两个八字节长度的字段，或者字段的数据类型来确定。

## 3. 基于TPC的客户端的过程

当一个基于TCP的客户端希望建立一个连接到一个仅能通过防火墙可达的目标，它必须打开一个到SOCKS服务器系统的合适的SOCKS端口的TCP连接。SOCKS服务通常位于TCP的1080端口上。如果连接请求成功，客户端将选择以哪种方式进行认证，并通过选择的认证方式鉴权，然后发送一个转发请求。SOCKS服务器验证这个请求，然后将建立这个连接或者拒绝它。

Unless otherwise noted, the decimal numbers appearing in packetformat diagrams represent the length of the corresponding field, in octets. Where a given octet must take on a specific value, the syntax X'hh' is used to denote the value of the single octet in that field. When the word 'Variable' is used, it indicates that the corresponding field has a variable length defined either by an associated (one or two octet) length field, or by a data type field.

客户端连接上服务器，发送一个版本号和一个方法选择信息：

| VER | NMETHODS | METHODS |
| ---- | ---------- | -------- |
| 1 | 1 | 1 to 255 |

VER字段被设置为X'05'，表示协议的版本。NMETHODS字段的值为METHODS字段中出现过的8字节的认证方法编号的数字。

服务器选择给定方法中的一个，然后发送一个方法选择信息：

| VER | METHODS |
| ---- | ---------- |
| 1 | 1 |

如果选择的方法为X'FF'，表示客户端方法列表中没有一个可以接受，那么客户端就必须关闭这个连接。

当前定义的方法的值为：
* X'00' 不需要身份验证
* X'01' GSSAPI
* X'02' 用户名/密码验证
* X'03' to X'7F' Internet Assigned Numbers Authority (IANA) ASSIGNED
* X'80' to X'FE' 被保留，用于私有方法
* X'FF' 不可接受的方法
然后，客户端和服务器将进行特定方法的进一步子协商（sub-negotiation）。

基于方法依赖的子协商将会在单独的文档中进行叙述。

为此协议编写新方法的开发者需要联系IANA来获取一个方法编号。`绑定编号`文档应该被引用到当前的方法编号列表及其对应协议中。

兼容的实现方式必须支持GSSAPI和用户名/密码认证方法。

## 4. 请求

一旦方法依赖的子协商过程完成，客户端就会发送请求信息。如果协商方法包含了用于完整性检查和/或机密性的封装，则这些请求必须封装在依赖于方法的封装中。

SOCKS请求格式如下:

| VER | CMD | RSV | ATYP | DST.ADDR | DST.PORT |
| ---- | ---- | ---- | ---- | ------- | ------- |
| 1 | 1 | X'00' | 1 | Variable | 2 |

其中:
* VER 协议版本: X'05'
* CMD
  * 连接 X'01'
  * 绑定 X'02'
  * UDP关联 X'03'
* RSV 保留
* ATYP 如下地址的地址类型
  * IPv4地址: X'01'
  * 域名: X'03'
  * IPv6地址: X'04'
* DST.ADDR 期望的目标地址
* DST.PORT 以网络8字节序表示的期望的目标端口

SOCKS服务器通常会根据源地址和目的地址来验证请求，以请求类型返回相应的一个或多个应答消息。

## 5. 寻址

在一个地址字段（DST.ADDR, BND.ADDR），ATYP字段中指定的地址类型：
* X'01'  
地址是一个长度为4个8字节的IPv4。
* X'03'  
地址字段包含一个完全限定的域名，地址字段的第一个8字节包含后续8字节数据的数目，没有结束的NUL8字节。
* X'04'  
地址是一个长度为16个8字节的IPv6。

## 6. 应答

SOCKS请求信息在客户端与SOCKS服务器建立连接后立即发送，并完成认证协商。服务器验证请求，并以如下格式返回一个应答信息：

| VER | REP | RSV | ATYP | BND.ADDR | BND.PORT |
| ---- | ---- | ---- | ---- | ------- | ------- |
| 1 | 1 | X'00' | 1 | Variable | 2 |

其中:
* VER 协议版本: X'05'
* REP 回复字段:
  * X'00' 成功
  * X'01' 一般的SOCKS服务器鼓掌
  * X'02' 规则集不允许的连接
  * X'03' 网络不通
  * X'04' 主机不可达
  * X'05' 连接被拒绝
  * X'06' TTL过期
  * X'07' 命令不支持
  * X'08' 地址类型不支持
  * X'09' to X'FF' 未指定
* RSV 保留
* ATYP 如下的地址类型
  * IPv4地址: X'01'
  * 字段名: X'03'
  * IPv6地址: X'04'
* BND.ADDR 服务器绑定地址
* BND.PORT 以网络8字节序表示的服务器绑定端口

被标记为RESERVED (RSV)的字段必须设为 X'00'。

如果所选择的方法包括用于认真、完整性和/或机密性的封装，则将应答封装在依赖于方法的封装中。

### 连接

在对连接的应答中，BND.PORT包含了服务器分配给目标主机的端口号，而BND.ADDR则包含了相关联的IP地址。所提供的BND.ADDR常常不同于客户端用来连接SOCKS服务器的IP地址，因为这样的服务器通常是多归属的（multi-homed）。SOCKS服务器将会使用 DST.ADDR和DST.PORT，以及客户端在验证连接请求中的源地址和端口。

### 绑定

绑定请求在协议中被使用，要求客户端接受服务器的连接。FTP是一个著名的例子，它使用主要的客户端到服务器的连接来发送命令和状态报告，但可能使用一个服务器到客户端的连接来按需传输数据（例如LS、GET、PUT）

一个应用协议中的客户端将在用`CONNENT`建立好主连接之后使用`绑定请求`，并仅用来建立次要连接。SOCKS服务器将使用用于验证绑定请求的DST.ADDR和DST.PORT。

在绑定操作期间，从SOCKS服务器向客户端发送两个应答。第一个是在服务器创建并绑定一个新的socket后发送的。BND.PORT字段包含SOCKS服务器绑定的监听传入连接的端口号。BND.ADDR字段包含相关的IP地址。客户端通常使用这些信息来通知（通过主连接或控制连接）交会地址的应用服务器。第二次应答仅发生在预期的传入连接成功或失败之后。

在第二次应答中，BND.PORT和BND.ADDR字段包含连接主机的地址和端口号。

### UDP关联

UDP关联请求用于建立一个与UDP转发进程的关联去处理UDP数据报。DST.ADDR和DST.PORT字段包含客户端希望用来为关联发送UDP数据报的地址和端口。服务器可能使用此信息去限对关联的访问。如果客户端在UDP关联时不占有信息，那么客户端必须使用全为0的端口号和地址。

一个UDP关联将会在其请求的TCP连接到达终端时中止。

在对UDP关联的应答中，BND.PORT和BND.ADDR字段指定了客户端必须发送的需要转发的UDP请求信息的端口号/地址。

### 应答过程

当一个应答（REP取X'00'以外的值）表明故障时，SOCKS服务器必须在发送应答后立即中止TCP连接。这必须在检测到造成故障的情况后10秒内完成。

如果应答代码（REP取值X'00'）表明成功，并且请求是一个绑定或者一个连接，则客户端可以现在开始传送数据。如果所选择的验证方法支持完整性、认证和/或机密性的封装，那么数据需要用依赖于方法的封装进行封装。类似地，当客户端的数据到达SOCKS服务器时，服务器必须封装用正在使用的认证方法去封装数据。

## 7. 基于UDP的客户端程序过程

一个基于UDP的客户端必须发送它的数据报到在UDP关联请求应答中BND.PORT指定的UDP端口的UDP转发服务器。如果选择的认证方法提供对认证、完整性、和/或机密性的封装，则数据报必须用合适的封装方法来封装。每个UDP数据报都带有一个UDP请求头：

| RSV | FRAG | ATYP | DST.ADDR | DST.PORT | DATA |
| ---- | ---- | ---- | ------- | ------- | ------- |
| 2 | 1 | 1 | Variable | 2 | Variable |

UDP请求头的字段为:
* RSV 保留 X'0000'
* FRAG 当前片号
* ATYP 如下地址的地址类型:
  * IPv4地址: X'01'
  * 域名: X'03'
  * IPv6地址: X'04'
* DST.ADDR 期望的目的地址
* DST.PORT 期望的目的端口
* DATA 用户数据

当一个UDP转发服务器决定转发一个数据报时，它会默默地进行，而不向请求客户端发出任何通知。类似地，它将丢弃不能或者不会转发的数据报。当一个UDP转发服务器从远程主机接收应答数据报时，它必须使用上述UDP请求头对该数据报进行封装，以及依赖于认证方法的任何封装方法。

UDP转发服务器必须从SOCKS服务器取得将要发送数据包给BND.PORT的客户端预期的在UDP关联应答中给定的IP地址。它必须丢弃任何源IP地址到来的任何数据报而不是特定关联记录的数据报。

FRAG字段表明这个数据报是否是多个片（fragments）之一。如果实现，高比特位表明片结尾部分的序列，如果值为X'00'表明该数据报是独立的。在1到127之间的值致命了一个片序列的片位置。每个接收器将会有一个与这些片关联的重组队列（REASSEMBLY QUEUE）和一个重组计时器（REASSEMBLY TIMER）。每当重组计时器超时或者一个新的带有FRAG字段并且值小于此片序列处理过的最高FRAG值的片到来，那么重组队列必须被重新初始化，并且关联的片都将被丢弃。重组计时器的时间必须不小于5秒。建议尽可能地通过应用层的设计不要使用分片功能。

分片的实现是可选的；一个不支持分片的实现必须丢弃所有FRAG字段为非X'00'值的数据报。

一个SOCKS-感知UDP的编程接口必须报告一个可用的比操作系统提供的实际空间更小的UDP数据报缓存空间。

* 如果 ATYP 值为 X'01' - 10+依赖于方法的八字节更小
* 如果 ATYP 值为 X'03' - 262+依赖于方法的八字节更小
* 如果 ATYP 值为 X'04' - 20+依赖于方法的八字节更小

## 8. 安全考虑

本文档描述了一个用于应用层的IP防火墙穿透协议。这种穿透的安全性与实际实现提供的以及SOCKS客户端和SOCKS服务器之间的协商期间选择的认证和封装方法高度相关。

管理员应慎重考虑认证方法的选择。

## 9. 参考文献

[1] Koblas, D., "SOCKS", Proceedings: 1992 Usenix Security Symposium.

## 作者地址

Marcus Leech  
Bell-Northern Research Ltd  
P.O. Box 3511, Stn. C,  
Ottawa, ON  
CANADA K1Y 4H7  

电话: (613) 763-9145  
邮箱: mleech@bnr.ca  
